# Bytedesk 后端数据结构文档

本文档详细说明 Bytedesk 后端系统的核心数据模型、实体关系和数据库结构。

## 目录

- [核心实体概述](#核心实体概述)
- [RBAC 权限模型](#rbac-权限模型)
- [基础实体结构](#基础实体结构)
- [模块实体详解](#模块实体详解)
- [实体关系图](#实体关系图)
- [数据库表命名规范](#数据库表命名规范)

---

## 核心实体概述

### 实体分类

| 分类 | 说明 | 模块 |
|------|------|------|
| **RBAC 实体** | 用户、角色、权限、组织 | modules/core |
| **IM 实体** | 消息、会话、群组 | modules/team |
| **客服实体** | 访客、工作组、路由 | modules/service |
| **AI 实体** | 机器人、智能体、对话 | modules/ai |
| **知识库实体** | 文章、分类、FAQ | modules/kbase |
| **工单实体** | 工单、流转、SLA | modules/ticket |

---

## RBAC 权限模型

### 1. UserEntity（用户实体）

**表名**: `bytedesk_core_user`

**描述**: 系统用户实体，用于用户认证、授权和基本信息管理

**核心字段**:

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | Long | 主键 ID | PK, Auto |
| uid | String | 用户唯一标识 | Unique |
| num | String | 用户编号 | - |
| username | String | 用户名（登录用） | NotNull |
| nickname | String | 昵称/显示名 | - |
| password | String | 加密密码 | - |
| email | String | 邮箱 | Email |
| country | String | 国家代码 | Default: "86" |
| mobile | String | 手机号 | - |
| avatar | String | 头像 URL | - |
| description | String | 个人简介 | - |
| sex | String | 性别 | Enum: MALE/FEMALE/UNKNOWN |
| registerSource | String | 注册来源 | Enum |
| enabled | Boolean | 是否启用 | Default: true |
| superUser | Boolean | 超级管理员 | Default: false |
| emailVerified | Boolean | 邮箱已验证 | Default: false |
| mobileVerified | Boolean | 手机已验证 | Default: false |
| passwordModifiedAt | ZonedDateTime | 密码修改时间 | - |
| currentOrganization | OrganizationEntity | 当前组织 | ManyToOne |
| currentRoles | Set<RoleEntity> | 当前角色 | ManyToMany |
| userOrganizationRoles | Set<UserOrganizationRoleEntity> | 组织角色 | OneToMany |
| createdAt | ZonedDateTime | 创建时间 | Auto |
| updatedAt | ZonedDateTime | 更新时间 | Auto |

**关系**:
- `currentOrganization` → `OrganizationEntity`: 多对一
- `currentRoles` → `RoleEntity`: 多对多
- `userOrganizationRoles` → `UserOrganizationRoleEntity`: 一对多

**枚举类型**:
- `Sex`: MALE, FEMALE, UNKNOWN
- `RegisterSource`: USERNAME, EMAIL, MOBILE, GITHUB, WECHAT, GOOGLE, DINGTALK, FEISHU, FACEBOOK, DOUYIN, APPLE, LDAP, OIDC, OPENID, CAS, ADMIN, SUPER, UNKNOWN

---

### 2. RoleEntity（角色实体）

**表名**: `bytedesk_core_role`

**描述**: 角色实体，用于权限分组和管理

**核心字段**:

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | Long | 主键 ID | PK, Auto |
| uid | String | 角色唯一标识 | Unique |
| name | String | 角色名称 | NotNull |
| value | String | 角色值 | - |
| description | String | 角色描述 | - |
| system | Boolean | 是否系统角色 | Default: false |
| authorities | Set<AuthorityEntity> | 权限集合 | ManyToMany |
| organization | OrganizationEntity | 所属组织 | ManyToOne |
| createdAt | ZonedDateTime | 创建时间 | Auto |
| updatedAt | ZonedDateTime | 更新时间 | Auto |

**关系**:
- `authorities` → `AuthorityEntity`: 多对多
- `organization` → `OrganizationEntity`: 多对一

---

### 3. AuthorityEntity（权限实体）

**表名**: `bytedesk_core_authority`

**描述**: 权限实体，定义系统中的操作权限

**核心字段**:

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | Long | 主键 ID | PK, Auto |
| uid | String | 权限唯一标识 | Unique |
| name | String | 权限名称 | NotNull |
| value | String | 权限值 | - |
| description | String | 权限描述 | - |
| type | String | 权限类型 | - |
| createdAt | ZonedDateTime | 创建时间 | Auto |
| updatedAt | ZonedDateTime | 更新时间 | Auto |

**关系**:
- `roles` → `RoleEntity`: 多对多

---

### 4. OrganizationEntity（组织实体）

**表名**: `bytedesk_core_organization`

**描述**: 组织/公司实体，用于多租户组织管理

**核心字段**:

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | Long | 主键 ID | PK, Auto |
| uid | String | 组织唯一标识 | Unique |
| name | String | 组织名称 | NotNull |
| logo | String | 组织 Logo | - |
| code | String | 组织代码 | - |
| description | String | 组织描述 | - |
| forceValidateEmail | Boolean | 强制验证邮箱 | Default: false |
| forceValidateMobile | Boolean | 强制验证手机 | Default: false |
| verifiedType | String | 认证类型 | Enum |
| identityType | String | 证件类型 | Enum |
| identityImage | String | 证件图片 | - |
| identityNumber | String | 证件号码 | - |
| verifyDate | ZonedDateTime | 认证时间 | - |
| verifyStatus | String | 认证状态 | Enum |
| rejectReason | String | 拒绝原因 | - |
| vip | Boolean | 是否付费会员 | Default: false |
| vipExpireDate | ZonedDateTime | VIP 截止日期 | - |
| enabled | Boolean | 是否启用 | Default: true |
| user | UserEntity | 组织管理员 | ManyToOne |
| createdAt | ZonedDateTime | 创建时间 | Auto |
| updatedAt | ZonedDateTime | 更新时间 | Auto |

**关系**:
- `user` → `UserEntity`: 多对一

**枚举类型**:
- `OrganizationVerifyTypeEnum`: COMPANY, INDIVIDUAL, GOVERNMENT
- `OrganizationIdentityTypeEnum`: COMPANY_LICENSE, ID_CARD, PASSPORT, OTHER
- `OrganizationVerifyStatusEnum`: UNVERIFIED, VERIFIED, PENDING, REJECTED

---

### 5. UserOrganizationRoleEntity（用户组织角色关联实体）

**表名**: `bytedesk_core_user_organization_role`

**描述**: 用户、组织、角色的多对多关联实体

**核心字段**:

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | Long | 主键 ID | PK, Auto |
| uid | String | 关联唯一标识 | Unique |
| user | UserEntity | 用户 | ManyToOne |
| organization | OrganizationEntity | 组织 | ManyToOne |
| roles | Set<RoleEntity> | 角色集合 | ManyToMany |
| startDate | ZonedDateTime | 角色开始时间 | - |
| endDate | ZonedDateTime | 角色结束时间 | - |

**关系**:
- `user` → `UserEntity`: 多对一
- `organization` → `OrganizationEntity`: 多对一
- `roles` → `RoleEntity`: 多对多

---

### 6. TokenEntity（令牌实体）

**表名**: `bytedesk_core_token`

**描述**: 用户认证令牌实体

**核心字段**:

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | Long | 主键 ID | PK, Auto |
| uid | String | 令牌唯一标识 | Unique |
| token | String | JWT 令牌 | - |
| refreshToken | String | 刷新令牌 | - |
| user | UserEntity | 所属用户 | ManyToOne |
| expired | Boolean | 是否过期 | Default: false |
| expiredAt | ZonedDateTime | 过期时间 | - |
| createdAt | ZonedDateTime | 创建时间 | Auto |

---

## 基础实体结构

### BaseEntity（基础实体）

所有实体的基类，提供通用字段：

```java
public abstract class BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false, length = 64)
    private String uid;

    @CreatedDate
    @Column(nullable = false, updatable = false)
    private ZonedDateTime createdAt;

    @LastModifiedDate
    @Column(nullable = false)
    private ZonedDateTime updatedAt;

    @CreatedBy
    @Column(updatable = false)
    private String createdBy;

    @LastModifiedBy
    private String updatedBy;
}
```

### BaseEntityNoOrg（无组织基础实体）

不需要组织字段的实体基类：

```java
public abstract class BaseEntityNoOrg extends BaseEntity {
    // 继承基础实体字段，不包含组织
}
```

---

## 模块实体详解

### Team 模块（团队 IM）

#### ThreadEntity（会话实体）

**表名**: `bytedesk_team_thread`

**核心字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| uid | String | 会话唯一标识 |
| topic | String | 会话主题 |
| type | String | 会话类型: SINGLE/GROUP |
| users | Set<UserEntity> | 参与用户 |
| owner | UserEntity | 会话所有者 |

#### MessageEntity（消息实体）

**表名**: `bytedesk_team_message`

**核心字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| uid | String | 消息唯一标识 |
| thread | ThreadEntity | 所属会话 |
| sender | UserEntity | 发送者 |
| content | String | 消息内容 |
| type | String | 消息类型: TEXT/IMAGE/FILE |
| status | String | 消息状态 |

---

### Service 模块（客服系统）

#### VisitorEntity（访客实体）

**表名**: `bytedesk_service_visitor`

**核心字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| uid | String | 访客唯一标识 |
| nickname | String | 访客昵称 |
| avatar | String | 访客头像 |
| sessionId | String | 会话 ID |
| currentAgent | UserEntity | 当前客服 |

#### WorkgroupEntity（工作组实体）

**表名**: `bytedesk_service_workgroup`

**核心字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| uid | String | 工作组唯一标识 |
| name | String | 工作组名称 |
| agents | Set<UserEntity> | 客服列表 |
| routingStrategy | String | 路由策略 |

---

### AI 模块（AI 智能体）

#### RobotAgentEntity（机器人智能体实体）

**表名**: `bytedesk_ai_robot_agent`

**核心字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| uid | String | 智能体唯一标识 |
| name | String | 智能体名称 |
| avatar | String | 智能体头像 |
| type | String | AI 类型: ZHIPUAI/DEEPSEEK/... |
| model | String | 模型名称 |
| apiKey | String | API 密钥（加密） |
| systemPrompt | String | 系统提示词 |
| temperature | Double | 温度参数 |
| maxTokens | Integer | 最大 Tokens |

---

### Kbase 模块（知识库）

#### ArticleEntity（文章实体）

**表名**: `bytedesk_kbase_article`

**核心字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| uid | String | 文章唯一标识 |
| title | String | 文章标题 |
| content | String | 文章内容 |
| category | CategoryEntity | 所属分类 |
| tags | Set<TagEntity> | 标签集合 |
| status | String | 状态: DRAFT/PUBLISHED |

---

### Ticket 模块（工单系统）

#### TicketEntity（工单实体）

**表名**: `bytedesk_ticket_ticket`

**核心字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| uid | String | 工单唯一标识 |
| title | String | 工单标题 |
| description | String | 工单描述 |
| priority | String | 优先级 |
| status | String | 状态 |
| assignee | UserEntity | 处理人 |
| reporter | UserEntity | 报告人 |

---

## 实体关系图

### RBAC 关系图

```
UserEntity (用户)
    │
    ├── currentOrganization ──────> OrganizationEntity (组织)
    │
    ├── currentRoles ─────────────> RoleEntity (角色)
    │                                    │
    └── userOrganizationRoles ────────> authorities ─────> AuthorityEntity (权限)
```

### 组织用户角色关系

```
OrganizationEntity (组织)
    │
    └── users ──────────> UserEntity (用户)
                              │
                              └── userOrganizationRoles ────> UserOrganizationRoleEntity
                                                                        │
                                                                        └── roles ────> RoleEntity
```

---

## 数据库表命名规范

### 命名规则

1. **表名格式**: `bytedesk_{module}_{entity}`
2. **全部小写**
3. **使用下划线分隔**
4. **包含模块前缀**

### 示例

| 模块 | 实体类 | 表名 |
|------|--------|------|
| core | UserEntity | bytedesk_core_user |
| core | RoleEntity | bytedesk_core_role |
| core | OrganizationEntity | bytedesk_core_organization |
| team | ThreadEntity | bytedesk_team_thread |
| team | MessageEntity | bytedesk_team_message |
| service | VisitorEntity | bytedesk_service_visitor |
| ai | RobotAgentEntity | bytedesk_ai_robot_agent |
| kbase | ArticleEntity | bytedesk_kbase_article |
| ticket | TicketEntity | bytedesk_ticket_ticket |

---

## 索引规范

### 索引命名

- **主键索引**: `PRIMARY`
- **唯一索引**: `uk_{table}_{column}`
- **普通索引**: `idx_{entity}_{column}`

### 示例

```java
@Table(
    name = "bytedesk_core_user",
    indexes = {
        @Index(name = "idx_user_uid", columnList = "uuid")
    }
)
```

---

## 字段类型映射

### Java 类型 → 数据库类型

| Java 类型 | 数据库类型 | 说明 |
|-----------|-----------|------|
| Long | BIGINT | 主键、外键 |
| String | VARCHAR | 变长字符串 |
| String | TEXT | 长文本 |
| Integer | INT | 整数 |
| Boolean | TINYINT(1) | 布尔值 |
| ZonedDateTime | DATETIME | 日期时间（带时区） |
| BigDecimal | DECIMAL | 金额、精确数值 |
| Enum | VARCHAR | 枚举值存储字符串 |

---

## 数据库初始化

### DDL 自动更新

```properties
# 开发环境：自动更新表结构
spring.jpa.hibernate.ddl-auto=update

# 生产环境：验证，不自动更新
# spring.jpa.hibernate.ddl-auto=validate
```

### 初始化脚本

位置：`starter/src/main/resources/db/migration/`

使用 Flyway 或 Liquibase 进行版本管理（可选）。

---

## 相关文档

- [安装和运行指南](./01-安装和运行指南.md)
- [代码项目结构说明](./02-代码项目结构说明.md)
- [第三方依赖说明](./03-第三方依赖说明.md)
- [环境变量和代码规范配置](./04-环境变量和代码规范配置.md)
