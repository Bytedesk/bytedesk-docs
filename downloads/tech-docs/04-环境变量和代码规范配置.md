# Bytedesk 后端环境变量和代码规范配置

本文档详细说明 Bytedesk 后端项目的环境变量配置和代码规范。

## 目录

- [环境变量配置](#环境变量配置)
- [配置文件说明](#配置文件说明)
- [核心配置项](#核心配置项)
- [代码规范](#代码规范)
- [代码检查工具](#代码检查工具)

---

## 环境变量配置

### 支持的环境

| 环境 | 配置文件 | 说明 |
|------|----------|------|
| **local** | `application-local.properties` | 本地开发环境 |
| **prod** | `application-prod.properties` | 生产环境 |
| **noai** | `application-noai.properties` | 无 AI 功能版本 |
| **open** | `application-open.properties` | 开放版本 |
| **kingbase** | `application-kingbase.properties` | KingBase 数据库版本 |

### 切换环境

在 `application.properties` 中设置：

```properties
spring.profiles.active=local
```

或通过命令行参数：

```bash
java -jar bytedesk-starter.jar --spring.profiles.active=prod
```

或通过环境变量：

```bash
export SPRING_PROFILES_ACTIVE=prod
java -jar bytedesk-starter.jar
```

---

## 配置文件说明

### 配置文件结构

```
starter/src/main/resources/
├── application.properties              # 主配置（公共配置）
├── application-local.properties        # 本地开发环境
├── application-prod.properties         # 生产环境
├── application-noai.properties         # 无 AI 版本
├── application-open.properties         # 开放版本
├── application-kingbase.properties     # KingBase 数据库
├── i18n/                               # 国际化文件
│   ├── messages.properties
│   └── swagger.properties
├── properties/                         # 分类配置文件
├── static/                             # 静态资源
└── templates/                          # 模板文件
```

### 主配置文件（application.properties）

```properties
# 应用信息
spring.application.name=bytedesk
application.title=https://www.weiyuai.cn
application.version=1.2.0

# 服务器配置
server.port=9003
spring.threads.virtual.enabled=true

# 字符编码
spring.config.encoding=UTF-8
server.servlet.encoding.charset=UTF-8
server.servlet.encoding.force=true

# FreeMarker 配置
spring.freemarker.template-loader-path=classpath:/templates/ftl/
spring.freemarker.suffix=.ftl
spring.freemarker.charset=UTF-8

# 国际化
spring.messages.basename=i18n/messages,i18n/swagger
spring.messages.encoding=UTF-8

# 激活环境
spring.profiles.active=local
```

---

## 核心配置项

### 1. 应用基础配置

```properties
# 应用名称
spring.application.name=bytedesk

# 应用版本
application.version=1.2.0

# 调试模式
bytedesk.debug=true

# 许可证密钥（加密存储）
bytedesk.licenseKey=ENC(...)
```

### 2. 服务器配置

```properties
# 服务端口
server.port=9003

# 虚拟线程启用（Java 21+）
spring.threads.virtual.enabled=true

# Servlet 编码
server.servlet.encoding.charset=UTF-8
server.servlet.encoding.force=true
server.servlet.encoding.enabled=true
```

### 3. 数据源配置

```properties
# 数据库 URL
spring.datasource.url=jdbc:mysql://localhost:3306/bytedesk?useUnicode=true&characterEncoding=UTF-8

# 数据库用户名
spring.datasource.username=root

# 数据库密码（建议加密）
spring.datasource.password=your-password

# 驱动类
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# 连接池配置
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000
```

### 4. JPA 配置

```properties
# DDL 自动更新
spring.jpa.hibernate.ddl-auto=update

# 显示 SQL
spring.jpa.show-sql=true

# 格式化 SQL
spring.jpa.properties.hibernate.format_sql=true

# 方言
spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect

# 二级缓存
spring.jpa.cache.use_second_level_cache=true
spring.jpa.cache.use_query_cache=true
```

### 5. Redis 配置

```properties
# Redis 主机
spring.data.redis.host=localhost

# Redis 端口
spring.data.redis.port=6379

# Redis 密码
spring.data.redis.password=

# Redis 数据库
spring.data.redis.database=0

# 连接超时
spring.data.redis.timeout=60000

# 连接池配置
spring.data.redis.lettuce.pool.max-active=20
spring.data.redis.lettuce.pool.max-idle=10
spring.data.redis.lettuce.pool.min-idle=5
```

### 6. 自定义配置

```properties
# 自定义配置启用
bytedesk.custom.enabled=true

# 应用名称（自定义）
bytedesk.custom.name=

# 应用 Logo
bytedesk.custom.logo=

# 应用描述
bytedesk.custom.description=

# 显示右下角聊天
bytedesk.custom.show-right-corner-chat=false

# 聊天位置
bytedesk.custom.right-corner-chat-placement=bottom-right

# 显示演示
bytedesk.custom.show-demo=true

# 隐私政策 URL
bytedesk.custom.privacy-policy-url=https://www.weiyuai.cn/pages/privacy.html

# 服务条款 URL
bytedesk.custom.terms-of-service-url=https://www.weiyuai.cn/pages/terms.html

# MQTT WebSocket URL
bytedesk.custom.mqtt-websocket-url=

# 默认语言
bytedesk.custom.lang=zh-CN
```

### 7. 登录认证配置

```properties
# 用户名登录
bytedesk.custom.login-username-enable=true

# 手机号登录
bytedesk.custom.login-mobile-enable=true

# 扫码登录
bytedesk.custom.login-scan-enable=true

# 微信登录
bytedesk.custom.login-wechat-enable=false

# GitHub 登录
bytedesk.custom.login-github-enable=true

# LDAP 登录
bytedesk.custom.login-ldap-enable=false

# OIDC 登录
bytedesk.custom.login-oidc-enable=false

# 2FA 双重验证
bytedesk.custom.login-2fa-enable=false

# 密码最大重试次数
bytedesk.custom.login-max-retry-count=3

# 锁定时间（分钟）
bytedesk.custom.login-max-retry-lock-time=10
```

### 8. 管理员配置

```properties
# 管理员邮箱
bytedesk.admin.email=admin@email.com

# 管理员密码（加密）
bytedesk.admin.password=ENC(...)

# 管理员昵称
bytedesk.admin.nickname=SuperAdmin

# 管理员手机
bytedesk.admin.mobile=13345678000

# 手机白名单
bytedesk.admin.mobile-whitelist=18888888000,18888888001

# 邮箱白名单
bytedesk.admin.email-whitelist=100@email.com,101@email.com

# 验证码
bytedesk.admin.validate-code=123456
```

### 9. 文件上传配置

```properties
# 文件上传路径
bytedesk.upload.path=/tmp/bytedesk/upload

# 最大文件大小
spring.servlet.multipart.max-file-size=100MB
spring.servlet.multipart.max-request-size=100MB

# 允许的文件类型
bytedesk.upload.allowed-types=jpg,jpeg,png,gif,pdf,doc,docx
```

### 10. AI 配置

```properties
# AI 启用
bytedesk.ai.enabled=true

# 默认 AI 提供商
bytedesk.ai.provider=zhipuai

# API Key（加密）
bytedesk.ai.api-key=ENC(...)

# 模型名称
bytedesk.ai.model=glm-4

# 温度参数
bytedesk.ai.temperature=0.7

# 最大 Tokens
bytedesk.ai.max-tokens=2000
```

---

## 代码规范

### 1. 命名规范

#### 类命名

```java
// 实体类：以 Entity 结尾
public class UserEntity {}

// 控制器：以 Controller 或 RestApiController 结尾
public class UserController {}
public class UserRestApiController {}

// 服务接口：以 Service 结尾
public interface UserService {}

// 服务实现：以 ServiceImpl 结尾
public class UserServiceImpl implements UserService {}

// 数据访问：以 Repository 结尾
public interface UserRepository extends JpaRepository<UserEntity, String> {}

// 请求模型：以 Request 结尾
public class CreateUserRequest {}

// 响应模型：以 Response 结尾
public class UserResponse {}

// 事件：以 Event 结尾
public class UserCreatedEvent {}
```

#### 方法命名

```java
// CRUD 操作
public UserEntity getById(String id) {}
public List<UserEntity> findAll() {}
public UserEntity save(UserEntity entity) {}
public void deleteById(String id) {}

// 查询操作：以 find/query/get 开头
public List<UserEntity> findByUsername(String username) {}
public List<UserEntity> queryByOrganizationId(String orgId) {}

// 判断操作：以 is/has/can 开头
public boolean isValid() {}
public boolean hasPermission() {}
public boolean canAccess() {}
```

#### 变量命名

```java
// 常量：全大写，下划线分隔
public static final String MAX_RETRY_COUNT = "3";
public static final int DEFAULT_TIMEOUT = 30000;

// 成员变量：小驼峰
private String userId;
private String username;

// 局部变量：小驼峰，见名知意
String currentUserEmail = "test@example.com";
```

#### 包命名

```
com.bytedesk.{module}.{layer}

示例：
com.bytedesk.core.controller
com.bytedesk.core.service
com.bytedesk.core.repository
com.bytedesk.core.entity
com.bytedesk.core.model.request
com.bytedesk.core.model.response
```

### 2. 注释规范

#### 类注释

```java
/**
 * 用户服务实现类
 *
 * <p>提供用户管理的核心业务逻辑，包括用户的创建、更新、删除和查询等操作。</p>
 *
 * @author bytedesk
 * @since 1.0.0
 */
@Service
public class UserServiceImpl implements UserService {
    // ...
}
```

#### 方法注释

```java
/**
 * 根据用户 ID 获取用户信息
 *
 * @param id 用户 ID，不能为空
 * @return 用户实体对象，如果不存在返回 null
 * @throws IllegalArgumentException 如果 ID 为空
 */
public UserEntity getById(String id) {
    // ...
}
```

#### 字段注释

```java
/**
 * 用户 ID
 */
@Id
private String id;

/**
 * 用户名，唯一标识
 */
@Column(unique = true, nullable = false)
private String username;
```

### 3. 代码结构规范

#### Controller 层

```java
@RestController
@RequestMapping("/api/users")
@Tag(name = "用户管理", description = "用户 CRUD 操作")
public class UserRestApiController {

    @Autowired
    private UserService userService;

    @GetMapping("/{id}")
    @Operation(summary = "获取用户详情")
    public ResponseEntity<?> getById(@PathVariable String id) {
        UserEntity user = userService.getById(id);
        return ResponseEntity.ok(UserResponse.fromEntity(user));
    }
}
```

#### Service 层

```java
@Service
@Transactional
public class UserServiceImpl implements UserService {

    @Autowired
    private UserRepository userRepository;

    @Override
    public UserEntity getById(String id) {
        Assert.hasText(id, "ID 不能为空");
        return userRepository.findById(id)
            .orElseThrow(() -> new NotFoundException("用户不存在"));
    }
}
```

#### Entity 层

```java
@Entity
@Table(name = "core_user")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class UserEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Column(unique = true, nullable = false, length = 50)
    private String username;

    @Column(nullable = false)
    private String password;

    @CreatedDate
    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @LastModifiedDate
    @Column(nullable = false)
    private LocalDateTime updatedAt;
}
```

### 4. 异常处理规范

```java
// 自定义异常
public class BusinessException extends RuntimeException {
    private String code;
    // ...
}

// 全局异常处理
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<?> handleBusinessException(BusinessException e) {
        return ResponseEntity.badRequest().body(e.getMessage());
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<?> handleException(Exception e) {
        return ResponseEntity.internalServerError().body("服务器错误");
    }
}
```

### 5. 日志规范

```java
@Slf4j
@Service
public class UserServiceImpl implements UserService {

    public void createUser(UserRequest request) {
        log.debug("开始创建用户: {}", request.getUsername());
        try {
            // 业务逻辑
            log.info("用户创建成功: {}", request.getUsername());
        } catch (Exception e) {
            log.error("用户创建失败: {}", request.getUsername(), e);
            throw e;
        }
    }
}

// 日志级别使用规范
// TRACE：最详细的调试信息
// DEBUG：调试信息
// INFO：关键业务流程
// WARN：警告信息，不影响业务
// ERROR：错误信息，需要关注
```

---

## 代码检查工具

### Lombok 配置

项目使用 Lombok 简化代码：

```xml
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <optional>true</optional>
</dependency>
```

常用注解：
- `@Data`：自动生成 getter/setter/toString/equals/hashCode
- `@Slf4j`：自动生成日志对象
- `@Builder`：构建者模式
- `@AllArgsConstructor`：全参构造器
- `@NoArgsConstructor`：无参构造器

### Javadoc 生成

```bash
# 生成 Javadoc
mvn javadoc:javadoc

# 跳过错误
mvn javadoc:javadoc -Dmaven.javadoc.failOnError=false
```

生成的文档位于：`starter/src/main/resources/static/javadocs/`

### 代码格式化

建议使用 IDE 的代码格式化功能：
- **IntelliJ IDEA**: `Cmd + Alt + L` (Mac) / `Ctrl + Alt + L` (Windows)
- **Eclipse**: `Ctrl + Shift + F`

---

## 配置加密

### 使用 Jasypt 加密敏感配置

```xml
<dependency>
    <groupId>com.github.ulisesbocchio</groupId>
    <artifactId>jasypt-spring-boot-starter</artifactId>
    <version>3.0.5</version>
</dependency>
```

### 加密配置值

```bash
# 加密字符串
java -cp jasypt-1.9.3.jar org.jasypt.intf.cli.JasyptPBEStringEncryptionCLI \
  input="your-password" \
  password=encryption-password \
  algorithm=PBEWithMD5AndDES
```

### 在配置文件中使用

```properties
# 加密后的值使用 ENC() 包裹
bytedesk.admin.password=ENC(encrypted_value_here)

# 启动时传入加密密码
java -jar bytedesk-starter.jar --jasypt.encryptor.password=encryption-password
```

---

## 环境变量最佳实践

### 1. 敏感信息使用环境变量

```properties
# 不在配置文件中硬编码敏感信息
spring.datasource.password=${DB_PASSWORD}
spring.data.redis.password=${REDIS_PASSWORD}
bytedesk.ai.api-key=${AI_API_KEY}
```

### 2. 使用 Spring Cloud Config（可选）

对于分布式系统，建议使用 Spring Cloud Config 统一管理配置。

### 3. 配置版本控制

- 不要将包含敏感信息的配置文件提交到代码仓库
- 使用 `application-local.properties.template` 作为模板
- 使用 `.gitignore` 排除本地配置文件

---

## 相关文档

- [安装和运行指南](./01-安装和运行指南.md)
- [代码项目结构说明](./02-代码项目结构说明.md)
- [第三方依赖说明](./03-第三方依赖说明.md)
- [数据结构文档](./05-数据结构文档.md)
