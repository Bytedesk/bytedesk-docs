# Bytedesk 后端代码项目结构说明

本文档详细说明 Bytedesk 后端项目的代码组织结构、模块划分和架构设计。

## 目录

- [整体架构](#整体架构)
- [项目目录结构](#项目目录结构)
- [模块详细说明](#模块详细说明)
- [代码分层规范](#代码分层规范)
- [设计模式与规范](#设计模式与规范)

---

## 整体架构

### 技术栈

- **框架**: Spring Boot 3.5.8
- **Java 版本**: JDK 17+
- **构建工具**: Maven
- **数据库**: MySQL / PostgreSQL / H2 / Oracle / KingBase
- **缓存**: Redis + Caffeine（本地缓存）
- **消息队列**: Redis + Spring Integration
- **ORM**: Spring Data JPA
- **API 文档**: SpringDoc OpenAPI
- **AI 集成**: Spring AI

### 架构模式

项目采用标准的 **分层架构** + **模块化设计**：

```
┌─────────────────────────────────────────────────────────────┐
│                      Starter (启动层)                         │
│                   StarterApplication                         │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    Modules (业务模块层)                      │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐   │
│  │core │ │team │ │service│ │ ai │ │kbase│ │ticket│ │ ... │   │
│  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                 Infrastructure (基础设施层)                   │
│     Spring Security │ JPA │ Redis │ WebSocket │ Netty       │
└─────────────────────────────────────────────────────────────┘
```

---

## 项目目录结构

### 顶层目录结构

```
bytedesk-private/
├── channels/              # 渠道集成模块
│   ├── wechat/           # 微信渠道
│   ├── douyin/           # 抖音渠道
│   └── shop/             # 电商渠道
├── modules/              # 核心业务模块
│   ├── core/            # 核心模块
│   ├── team/            # 团队 IM 模块
│   ├── service/         # 客服模块
│   ├── ai/              # AI 智能体模块
│   ├── kbase/           # 知识库模块
│   ├── ticket/          # 工单模块
│   ├── call/            # 呼叫中心模块
│   ├── conference/      # 视频会议模块
│   ├── voc/             # 客户之声模块
│   ├── forum/           # 论坛模块
│   ├── social/          # 社交模块
│   └── remote/          # 远程调用模块
├── enterprise/          # 企业版本模块
│   ├── core/
│   ├── ai/
│   ├── kbase/
│   ├── service/
│   ├── ticket/
│   └── call/
├── starter/             # 应用启动模块
├── control/             # 控制面板模块
├── plugins/             # 插件模块
├── projects/            # 项目模块
└── pom.xml             # Maven 父 POM
```

---

## 模块详细说明

### 1. starter（启动模块）

**位置**: `starter/`

**职责**:
- 应用程序入口
- 全局配置管理
- 组件扫描和初始化
- 外部化配置

**核心文件**:
```
starter/
├── src/main/java/com/bytedesk/starter/
│   ├── StarterApplication.java      # 应用启动类
│   ├── config/                      # 全局配置
│   │   └── properties/              # 配置属性类
│   ├── controller/                  # 基础控制器
│   ├── runner/                      # 启动运行器
│   └── swagger/                     # API 文档配置
└── src/main/resources/
    ├── application.properties       # 主配置文件
    ├── application-*.properties     # 环境配置文件
    ├── i18n/                        # 国际化文件
    ├── static/                      # 静态资源
    └── templates/                   # 模板文件
```

---

### 2. modules/core（核心模块）

**位置**: `modules/core/`

**职责**:
- RBAC 权限管理（用户、角色、权限、组织）
- 基础实体和通用功能
- 任务列表管理
- 助手管理
- 合同管理
- 关系管理

**核心包结构**:
```
modules/core/src/main/java/com/bytedesk/core/
├── rbac/                            # 权限管理
│   ├── user/                        # 用户
│   ├── role/                        # 角色
│   ├── permission/                  # 权限
│   ├── authority/                   # 权限定义
│   ├── organization/                # 组织机构
│   ├── organization_apply/          # 组织申请
│   ├── token/                       # 令牌管理
│   └── auth/                        # 认证
├── task_list/                       # 任务列表
├── assistant/                       # 助手
├── contract/                        # 合同
├── relation/                        # 关系
└── schedule/                        # 日程
```

**关键类**:
- `UserEntity`: 用户实体
- `RoleEntity`: 角色实体
- `OrganizationEntity`: 组织实体
- `TokenEntity`: 令牌实体

---

### 3. modules/team（团队 IM 模块）

**位置**: `modules/team/`

**职责**:
- 即时通讯核心功能
- 单聊、群聊消息
- 消息推送和同步
- 会话管理

**核心包结构**:
```
modules/team/src/main/java/com/bytedesk/team/
├── config/                          # 配置
├── controller/                      # 控制器
├── service/                         # 服务
├── repository/                      # 数据访问
└── entity/                          # 实体
```

---

### 4. modules/service（客服模块）

**位置**: `modules/service/`

**职责**:
- 客服工作台
- 访客管理
- 工作组路由
- 消息纠偏
- 节假日管理
- 工作时间设置
- 快捷回复
- 访客认证和令牌

**核心包结构**:
```
modules/service/src/main/java/com/bytedesk/service/
├── visitor_auth/                    # 访客认证
├── visitor_token/                   # 访客令牌
├── visitor_message/                 # 访客消息
├── workgroup_routing/               # 工作组路由
├── workgroup_settings/              # 工作组设置
├── worktime_settings/               # 工作时间设置
├── message_correction/              # 消息纠偏
├── holiday/                         # 节假日
├── form/                            # 表单
├── channel_app/                     # 渠道应用
└── config/                          # 配置
```

---

### 5. modules/ai（AI 智能体模块）

**位置**: `modules/ai/`

**职责**:
- AI 智能体管理
- 多 AI 提供商集成
- Spring AI 集成
- 机器人会话管理

**核心包结构**:
```
modules/ai/src/main/java/com/bytedesk/ai/
├── config/                          # AI 配置
├── springai/                        # Spring AI 集成
│   ├── config/                      # Spring AI 配置
│   └── providers/                   # AI 提供商
│       ├── zhipuai/                 # 智谱 AI
│       ├── deepseek/                # DeepSeek
│       ├── baidu/                   # 百度文心
│       ├── gemini/                  # Google Gemini
│       ├── openai/                  # OpenAI
│       ├── volcengine/              # 火山引擎
│       ├── tencent/                 # 腾讯混元
│       ├── dashscope/               # 阿里通义千问
│       ├── minimax/                 # MiniMax
│       ├── gitee/                   # Gitee AI
│       └── ...                      # 更多提供商
├── zhipuai/                         # 智谱 AI 特定功能
├── segment/                         # 分词
└── robot/                           # 机器人
```

**支持的 AI 提供商**:
- ZhipuAI（智谱 AI）
- DeepSeek
- Baidu（百度文心一言）
- Google Gemini
- OpenAI
- Volcengine（火山方舟）
- Tencent（腾讯混元）
- Dashscope（阿里通义千问）
- MiniMax
- Gitee AI
- OpenRouter
- SiliconFlow
- Ollama（本地）

---

### 6. modules/kbase（知识库模块）

**位置**: `modules/kbase/`

**职责**:
- 知识库管理
- 文章管理
- FAQ 管理
- 知识库分类

---

### 7. modules/ticket（工单模块）

**位置**: `modules/ticket/`

**职责**:
- 工单创建和分配
- 工单流转
- SLA 管理
- 工单统计

---

### 8. modules/call（呼叫中心模块）

**位置**: `modules/call/`

**职责**:
- 呼叫控制
- 通话记录
- 坐席管理
- 呼叫路由

---

### 9. modules/conference（视频会议模块）

**位置**: `modules/conference/`

**职责**:
- 视频会议管理
- 会议房间
- 参会者管理
- Jitsi 集成

---

### 10. modules/voc（客户之声模块）

**位置**: `modules/voc/`

**职责**:
- 客户反馈收集
- 满意度调查
- 数据分析

---

### 11. modules/forum（论坛模块）

**位置**: `modules/forum/`

**职责**:
- 社区论坛
- 帖子管理
- 评论管理

---

### 12. modules/social（社交模块）

**位置**: `modules/social/`

**职责**:
- 社交功能
- 动态发布
- 关注/粉丝

---

### 13. modules/remote（远程调用模块）

**位置**: `modules/remote/`

**职责**:
- 远程服务调用
- 外部 API 集成

---

## 代码分层规范

### 标准分层结构

每个业务模块通常采用以下分层结构：

```
com.bytedesk.{module}/
├── controller/                      # 控制器层（API 接口）
│   ├── rest/                        # REST API
│   └── websocket/                   # WebSocket API
├── service/                         # 服务层（业务逻辑）
│   └── impl/                        # 服务实现
├── repository/                      # 数据访问层
├── entity/                          # 实体层（JPA）
├── model/                           # 模型层（DTO/VO/Request/Response）
│   ├── request/                     # 请求模型
│   └── response/                    # 响应模型
├── event/                           # 事件（领域事件）
├── config/                          # 模块配置
├── exception/                       # 异常定义
└── util/                            # 工具类
```

### 分层职责说明

#### Controller 层

**职责**:
- 接收 HTTP 请求
- 参数验证
- 调用 Service 层
- 返回响应

**命名规范**:
- REST Controller: `*RestApiController`
- WebSocket Controller: `*WebSocketController`

#### Service 层

**职责**:
- 实现业务逻辑
- 事务管理
- 调用 Repository 层

**命名规范**:
- 接口: `*Service`
- 实现: `*ServiceImpl`

#### Repository 层

**职责**:
- 数据访问
- 继承 Spring Data JPA 接口

**命名规范**:
- `*Repository`

#### Entity 层

**职责**:
- 数据库表映射
- JPA 注解
- 实体关系定义

**命名规范**:
- `*Entity`

#### Model 层

**职责**:
- 数据传输对象（DTO）
- 视图对象（VO）
- 请求/响应模型

**命名规范**:
- 请求: `*Request`
- 响应: `*Response`

---

## 设计模式与规范

### 1. Event-Driven Architecture（事件驱动架构）

项目使用事件驱动模式实现模块间解耦：

```java
// 事件定义
public class UserCreatedEvent {
    private String userId;
    private String username;
    // ...
}

// 事件发布
@Autowired
private ApplicationEventPublisher eventPublisher;

public void createUser(UserRequest request) {
    // 业务逻辑
    eventPublisher.publishEvent(new UserCreatedEvent(...));
}

// 事件监听
@EventListener
public void handleUserCreated(UserCreatedEvent event) {
    // 处理事件
}
```

### 2. 依赖注入

使用 Spring 的依赖注入：

```java
@Service
public class UserServiceImpl implements UserService {

    @Autowired
    private UserRepository userRepository;

    // 或使用构造器注入（推荐）
    private final UserRepository userRepository;

    public UserServiceImpl(UserRepository userRepository) {
        this.userRepository = userRepository;
    }
}
```

### 3. 异常处理

统一异常处理：

```java
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(Exception.class)
    public ResponseEntity<?> handleException(Exception e) {
        // 统一处理
    }
}
```

### 4. API 设计规范

RESTful API 设计：

```
GET    /api/users           # 获取用户列表
GET    /api/users/{id}      # 获取单个用户
POST   /api/users           # 创建用户
PUT    /api/users/{id}      # 更新用户
DELETE /api/users/{id}      # 删除用户
```

### 5. 命名规范

| 类型 | 命名规范 | 示例 |
|------|----------|------|
| 类名 | PascalCase | `UserService` |
| 方法名 | camelCase | `getUserById` |
| 常量 | UPPER_SNAKE_CASE | `MAX_RETRY_COUNT` |
| 包名 | 小写点分隔 | `com.bytedesk.core` |

---

## 模块依赖关系

### 依赖规则

1. **所有模块都可依赖 `modules/core`**
2. **业务模块之间避免循环依赖**
3. **Starter 模块聚合所有模块**
4. **Enterprise 模块依赖对应的基础模块**

### 依赖示例

```xml
<!-- service 模块依赖 core 模块 -->
<dependency>
    <groupId>com.bytedesk</groupId>
    <artifactId>core</artifactId>
    <version>${revision}</version>
</dependency>
```

---

## 配置管理

### 多环境配置

```
application.properties              # 公共配置
application-local.properties        # 本地开发
application-prod.properties         # 生产环境
application-noai.properties         # 无 AI 版本
application-kingbase.properties     # KingBase 数据库
```

### 配置激活

```properties
spring.profiles.active=local
```

---

## 相关文档

- [安装和运行指南](./01-安装和运行指南.md)
- [第三方依赖说明](./03-第三方依赖说明.md)
- [环境变量配置](./04-环境变量和代码规范配置.md)
- [数据结构文档](./05-数据结构文档.md)
