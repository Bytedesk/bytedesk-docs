# Bytedesk 后端安装和运行指南

本文档提供 Bytedesk 后端系统的安装、配置和运行说明。

## 目录

- [系统要求](#系统要求)
- [开发环境准备](#开发环境准备)
- [项目构建](#项目构建)
- [配置说明](#配置说明)
- [运行应用](#运行应用)
- [常见问题](#常见问题)

---

## 系统要求

### 软件依赖

| 组件 | 版本要求 | 说明 |
|------|----------|------|
| JDK | 17+ | 必须使用 JDK 17 或更高版本 |
| Maven | 3.8+ | 用于项目构建和依赖管理 |
| MySQL | 8.0+ | 主数据库，也可使用 PostgreSQL/H2/Oracle/KingBase |
| Redis | 6.0+ | 缓存和消息队列 |
| Node.js | 18+ | 前端构建（如需） |

### 推荐开发工具

- IntelliJ IDEA（推荐）或 Eclipse
- DataGrip 或 MySQL Workbench
- Redis Insight（Redis 可视化管理）
- Postman 或 Apifox（API 测试）

---

## 开发环境准备

### 1. 安装 JDK 17

```bash
# macOS (使用 Homebrew)
brew install openjdk@17

# 验证安装
java -version
```

### 2. 安装 Maven

```bash
# macOS
brew install maven

# 验证安装
mvn -v
```

### 3. 安装 MySQL

```bash
# macOS
brew install mysql
brew services start mysql

# 创建数据库
mysql -u root -p
CREATE DATABASE bytedesk CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 4. 安装 Redis

```bash
# macOS
brew install redis
brew services start redis

# 验证 Redis 运行
redis-cli ping
# 应返回: PONG
```

---

## 项目构建

### 克隆项目

```bash
git clone <repository-url>
cd bytedesk-private
```

### Maven 构建命令

```bash
# 完整构建（包含测试）
mvn clean install

# 跳过测试构建（推荐）
mvn clean install -DskipTests

# 仅构建特定模块
mvn clean install -pl modules/core

# 打包为 JAR
mvn clean package -DskipTests
```

### 构建产物

构建成功后，主要产物位于：

- **主 JAR 文件**: `starter/target/bytedesk-starter.jar`
- **Javadocs**: `starter/src/main/resources/static/javadocs/`

---

## 配置说明

### 配置文件结构

```
starter/src/main/resources/
├── application.properties              # 主配置文件
├── application-local.properties        # 本地开发环境
├── application-prod.properties         # 生产环境
├── application-noai.properties         # 无 AI 版本
├── application-open.properties         # 开放版本
├── application-kingbase.properties     # KingBase 数据库配置
├── i18n/                               # 国际化文件
├── static/                             # 静态资源
└── templates/                          # 模板文件
```

### 激活配置环境

在 `application.properties` 中设置：

```properties
# 开发环境
spring.profiles.active=local

# 生产环境
# spring.profiles.active=prod

# 无 AI 环境
# spring.profiles.active=noai

# KingBase 数据库
# spring.profiles.active=kingbase
```

### 核心配置项

#### 服务器配置

```properties
# 应用名称
spring.application.name=bytedesk

# 服务端口
server.port=9003

# 字符编码
server.servlet.encoding.charset=UTF-8
server.servlet.encoding.force=true
```

#### 数据库配置

在对应环境的 properties 文件中配置：

```properties
# MySQL 数据源示例
spring.datasource.url=jdbc:mysql://localhost:3306/bytedesk?useUnicode=true&characterEncoding=UTF-8
spring.datasource.username=root
spring.datasource.password=your-password
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# JPA 配置
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
```

#### Redis 配置

```properties
spring.data.redis.host=localhost
spring.data.redis.port=6379
spring.data.redis.password=
spring.data.redis.database=0
```

---

## 运行应用

### 方式一：使用 Maven 运行（开发环境）

```bash
cd starter
mvn spring-boot:run
```

### 方式二：运行 JAR 包

```bash
# 构建
mvn clean package -DskipTests

# 运行
java -jar starter/target/bytedesk-starter.jar

# 指定配置文件运行
java -jar starter/target/bytedesk-starter.jar --spring.profiles.active=prod
```

### 方式三：在 IDE 中运行

1. 在 IntelliJ IDEA 中打开项目
2. 找到 `starter/src/main/java/com/bytedesk/starter/StarterApplication.java`
3. 右键点击 `main` 方法，选择 "Run 'StarterApplication'"

### 验证应用启动

应用启动成功后，可以通过以下方式验证：

```bash
# 检查健康状态
curl http://localhost:9003/actuator/health

# 访问 API 文档
浏览器打开: http://localhost:9003/swagger-ui/index.html

# 访问 Javadocs
浏览器打开: http://localhost:9003/javadocs/index.html
```

### 默认登录信息

```
用户名: admin@email.com
密码: admin
```

---

## 常见问题

### 1. 端口被占用

```
Error: Port 9003 is already in use
```

**解决方案**：修改 `server.port` 或停止占用端口的进程

```bash
# macOS/Linux 查找占用进程
lsof -i :9003
kill -9 <PID>
```

### 2. 数据库连接失败

```
CommunicationsException: Communications link failure
```

**检查清单**：
- MySQL 服务是否启动
- 数据库地址、端口、用户名、密码是否正确
- 防火墙是否允许连接

### 3. Redis 连接失败

```
RedisConnectionException: Unable to connect to Redis
```

**检查清单**：
- Redis 服务是否启动：`redis-cli ping`
- Redis 配置是否正确
- Redis 密码是否正确

### 4. Maven 依赖下载失败

```
Could not resolve dependencies
```

**解决方案**：

```bash
# 清理并重新下载
mvn clean install -U

# 配置国内镜像（可选）
# 编辑 ~/.m2/settings.xml，添加阿里云镜像
```

### 5. 内存不足

```
Java heap space
```

**解决方案**：增加 JVM 内存

```bash
java -Xmx2g -Xms1g -jar starter/target/bytedesk-starter.jar
```

---

## Docker 部署（可选）

### 使用 Docker Compose

项目提供了 Docker Compose 配置文件：

```bash
cd deploy/docker

# 无 AI 版本
docker compose -p bytedesk -f docker-compose-noai.yaml up -d

# ZhipuAI 版本（默认）
docker compose -p bytedesk -f docker-compose.yaml up -d

# Ollama 版本
docker compose -p bytedesk -f docker-compose-ollama.yaml up -d
```

### 查看日志

```bash
docker compose -p bytedesk logs -f
```

---

## 开发提示

### 热重载

使用 Spring Boot DevTools 实现热重载（已包含在依赖中）：

- 修改 Java 文件后自动重启
- 修改静态资源后自动刷新

### 调试模式

```bash
# 启用调试端口 5005
mvn spring-boot:run -Dagentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005
```

### 查看日志

日志输出位置：
- 控制台输出（开发环境）
- 文件输出（生产环境，配置在 `logback-spring.xml`）

---

## 相关文档

- [项目结构说明](./02-代码项目结构说明.md)
- [第三方依赖说明](./03-第三方依赖说明.md)
- [环境变量配置](./04-环境变量和代码规范配置.md)
- [数据结构文档](./05-数据结构文档.md)
